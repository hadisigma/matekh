<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatEKH - KI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // WICHTIG: Ersetze dies mit deiner Vercel URL nach dem Deploy!
        const API_URL = 'const API_URL = 'https://matekh-backend.vercel.app/api/chat';';
        
        // State Management
        let state = {
            isLoggedIn: null,
            isAdmin: false,
            username: '',
            password: '',
            chats: [],
            currentChatId: null,
            messages: [],
            input: '',
            sidebarOpen: false,
            messageCount: 0,
            guestMessageCount: 0,
            isLoading: false,
            showImageGen: false,
            imagePrompt: '',
            generatedImage: null,
            lastResetTime: Date.now()
        };

        const MAX_FREE_MESSAGES = 10;
        const RESET_INTERVAL = 60 * 60 * 1000;

        function render() {
            const app = document.getElementById('app');
            if (state.isLoggedIn === null) {
                app.innerHTML = renderLogin();
            } else {
                app.innerHTML = renderMain();
            }
            attachEventListeners();
        }

        function renderLogin() {
            return `
                <div class="min-h-screen bg-white flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-lg w-96">
                        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">MatEKH</h1>
                        
                        <div class="mb-6">
                            <input 
                                type="text" 
                                id="username" 
                                placeholder="Benutzername"
                                value="${state.username}"
                                class="w-full p-3 mb-4 border border-gray-300 rounded-lg"
                            />
                            <input 
                                type="password" 
                                id="password" 
                                placeholder="Passwort"
                                value="${state.password}"
                                class="w-full p-3 mb-4 border border-gray-300 rounded-lg"
                            />
                            <button 
                                id="loginBtn"
                                class="w-full bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition mb-3"
                            >
                                Anmelden
                            </button>
                        </div>

                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-300"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-2 bg-white text-gray-500">oder</span>
                            </div>
                        </div>

                        <button 
                            id="guestBtn"
                            class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition mt-4"
                        >
                            Abgemeldet bleiben
                        </button>
                        <p class="text-xs text-center mt-2 text-gray-600">
                            Als Gast: ${MAX_FREE_MESSAGES} Nachrichten pro Stunde
                        </p>

                        <p class="text-xs text-center mt-6 text-gray-500">Erstellt von Erik, Karem und Hadi</p>
                    </div>
                </div>
            `;
        }

        function renderMain() {
            return `
                <div class="flex h-screen bg-white">
                    ${renderSidebar()}
                    ${renderContent()}
                </div>
            `;
        }

        function renderSidebar() {
            return `
                <div class="${state.sidebarOpen ? 'translate-x-0' : '-translate-x-full'} fixed lg:relative lg:translate-x-0 w-64 bg-gray-900 text-white h-full transition-transform z-20">
                    <div class="p-4 border-b border-gray-700">
                        ${state.isLoggedIn === true ? `
                            <button id="newChatBtn" class="w-full flex items-center gap-2 bg-gray-800 hover:bg-gray-700 p-3 rounded-lg transition">
                                <span>‚ûï</span>
                                <span>Neuer Chat</span>
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="overflow-y-auto h-[calc(100vh-200px)]">
                        ${state.isLoggedIn === true ? state.chats.map(chat => `
                            <button 
                                class="chat-btn w-full text-left p-4 hover:bg-gray-800 transition flex items-center gap-2 ${state.currentChatId === chat.id ? 'bg-gray-800' : ''}"
                                data-id="${chat.id}"
                            >
                                <span>üí¨</span>
                                <span class="truncate">${chat.title}</span>
                            </button>
                        `).join('') : `
                            <div class="p-4 text-sm text-gray-400">
                                <p>üöÄ Melde dich an um Chats zu speichern!</p>
                            </div>
                        `}
                    </div>

                    <div class="absolute bottom-0 w-64 border-t border-gray-700">
                        ${state.isAdmin ? `
                            <button id="imageGenBtn" class="w-full p-4 hover:bg-gray-800 transition flex items-center gap-2">
                                <span>üñºÔ∏è</span>
                                <span>Bildgenerierung</span>
                            </button>
                        ` : ''}
                        <button id="logoutBtn" class="w-full p-4 hover:bg-gray-800 transition flex items-center gap-2">
                            <span>üö™</span>
                            <span>${state.isLoggedIn === true ? 'Abmelden' : 'Zur√ºck zum Login'}</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderContent() {
            return `
                <div class="flex-1 flex flex-col">
                    <div class="bg-white border-b border-gray-200 p-4 flex items-center justify-between">
                        <button id="menuBtn" class="lg:hidden p-2 hover:bg-gray-100 rounded">‚ò∞</button>
                        <h1 class="text-xl font-bold text-gray-800">MatEKH</h1>
                        <div class="text-sm text-gray-600">
                            ${state.isAdmin ? '‚àû Messages' : 
                              state.isLoggedIn === false ? 
                                `<div class="text-right">
                                    <div>${state.guestMessageCount}/${MAX_FREE_MESSAGES}</div>
                                    <div class="text-xs text-gray-500">Reset: ${getRemainingTime()}</div>
                                </div>` :
                                `${state.messageCount}/${MAX_FREE_MESSAGES}`
                            }
                        </div>
                    </div>

                    ${state.showImageGen && state.isAdmin ? renderImageGen() : renderChat()}
                </div>
            `;
        }

        function renderImageGen() {
            return `
                <div class="flex-1 p-6 overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-4">Bildgenerierung</h2>
                    <div class="flex gap-2 mb-4">
                        <input 
                            type="text" 
                            id="imagePrompt"
                            value="${state.imagePrompt}"
                            placeholder="Beschreibe dein Bild..."
                            class="flex-1 p-3 border border-gray-300 rounded-lg"
                        />
                        <button 
                            id="generateBtn"
                            ${state.isLoading ? 'disabled' : ''}
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                        >
                            ${state.isLoading ? '‚è≥' : 'Generieren'}
                        </button>
                    </div>
                    ${state.generatedImage ? `<img src="${state.generatedImage}" alt="Generated" class="max-w-full rounded-lg shadow-lg" />` : ''}
                </div>
            `;
        }

        function renderChat() {
            return `
                <div class="flex-1 p-6 overflow-y-auto" id="chatMessages">
                    ${state.messages.length === 0 ? `
                        <div class="text-center text-gray-500 mt-20">
                            <h2 class="text-2xl font-bold mb-2">MatEKH KI</h2>
                            <p>Starte eine Unterhaltung</p>
                            ${state.isLoggedIn === false ? `
                                <div class="mt-4 p-4 bg-blue-50 rounded-lg inline-block">
                                    <p class="text-sm text-blue-800">üéâ Gast-Modus: ${MAX_FREE_MESSAGES} Nachrichten pro Stunde kostenlos!</p>
                                </div>
                            ` : ''}
                        </div>
                    ` : state.messages.map(msg => `
                        <div class="mb-4 ${msg.role === 'user' ? 'text-right' : 'text-left'}">
                            <div class="inline-block p-4 rounded-lg max-w-xl ${msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'}">
                                ${msg.content}
                            </div>
                        </div>
                    `).join('')}
                    ${state.isLoading ? `
                        <div class="text-left mb-4">
                            <div class="inline-block p-4 rounded-lg bg-gray-100">
                                <div class="spinner">‚è≥</div>
                            </div>
                        </div>
                    ` : ''}
                </div>

                <div class="border-t border-gray-200 p-4">
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="messageInput"
                            value="${state.input}"
                            placeholder="Nachricht schreiben..."
                            class="flex-1 p-3 border border-gray-300 rounded-lg"
                        />
                        <button 
                            id="sendBtn"
                            ${state.isLoading ? 'disabled' : ''}
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50"
                        >‚û§</button>
                    </div>
                    <p class="text-xs text-center mt-2 text-gray-500">Erstellt von Erik, Karem und Hadi</p>
                </div>
            `;
        }

        function attachEventListeners() {
            const loginBtn = document.getElementById('loginBtn');
            const guestBtn = document.getElementById('guestBtn');
            const username = document.getElementById('username');
            const password = document.getElementById('password');
            const menuBtn = document.getElementById('menuBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const newChatBtn = document.getElementById('newChatBtn');
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            const imageGenBtn = document.getElementById('imageGenBtn');
            const generateBtn = document.getElementById('generateBtn');
            const imagePrompt = document.getElementById('imagePrompt');

            if (loginBtn) {
                loginBtn.onclick = handleLogin;
                username.oninput = (e) => { state.username = e.target.value; };
                password.oninput = (e) => { state.password = e.target.value; };
                password.onkeypress = (e) => { if (e.key === 'Enter') handleLogin(); };
            }
            if (guestBtn) guestBtn.onclick = handleGuestMode;
            if (menuBtn) menuBtn.onclick = () => { state.sidebarOpen = !state.sidebarOpen; render(); };
            if (logoutBtn) logoutBtn.onclick = handleLogout;
            if (newChatBtn) newChatBtn.onclick = createNewChat;
            if (sendBtn) sendBtn.onclick = sendMessage;
            if (messageInput) {
                messageInput.oninput = (e) => { state.input = e.target.value; };
                messageInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
            }
            if (imageGenBtn) imageGenBtn.onclick = () => { state.showImageGen = !state.showImageGen; render(); };
            if (generateBtn) generateBtn.onclick = generateImage;
            if (imagePrompt) imagePrompt.oninput = (e) => { state.imagePrompt = e.target.value; };

            document.querySelectorAll('.chat-btn').forEach(btn => {
                btn.onclick = () => loadChat(btn.dataset.id);
            });
        }

        function handleLogin() {
            if (state.username === 'erikkaremhadi' && state.password === 'erik123karem123hadi123') {
                state.isLoggedIn = true;
                state.isAdmin = true;
                state.messageCount = Infinity;
                loadChats();
                render();
            } else if (state.username && state.password) {
                state.isLoggedIn = true;
                state.isAdmin = false;
                state.messageCount = 0;
                loadChats();
                render();
            }
        }

        function handleGuestMode() {
            state.isLoggedIn = false;
            state.isAdmin = false;
            state.guestMessageCount = 0;
            state.lastResetTime = Date.now();
            render();
            startGuestTimer();
        }

        function handleLogout() {
            state = {
                isLoggedIn: null,
                isAdmin: false,
                username: '',
                password: '',
                chats: [],
                currentChatId: null,
                messages: [],
                input: '',
                sidebarOpen: false,
                messageCount: 0,
                guestMessageCount: 0,
                isLoading: false,
                showImageGen: false,
                imagePrompt: '',
                generatedImage: null,
                lastResetTime: Date.now()
            };
            render();
        }

        function createNewChat() {
            const newChat = {
                id: Date.now().toString(),
                title: `Neuer Chat ${state.chats.length + 1}`,
                messages: [],
                createdAt: new Date().toISOString()
            };
            
            state.chats.push(newChat);
            localStorage.setItem('matekh_chats', JSON.stringify(state.chats));
            state.currentChatId = newChat.id;
            state.messages = [];
            state.sidebarOpen = false;
            render();
        }

        function loadChat(chatId) {
            const chat = state.chats.find(c => c.id === chatId);
            if (chat) {
                state.messages = chat.messages;
                state.currentChatId = chatId;
                state.sidebarOpen = false;
                render();
            }
        }

        function loadChats() {
            const stored = localStorage.getItem('matekh_chats');
            if (stored) {
                state.chats = JSON.parse(stored);
            }
        }

        async function sendMessage() {
            if (!state.input.trim() || state.isLoading) return;
            
            if (state.isLoggedIn === false && state.guestMessageCount >= MAX_FREE_MESSAGES) {
                alert(`‚è∞ Du hast dein Limit von ${MAX_FREE_MESSAGES} Nachrichten pro Stunde erreicht!`);
                return;
            }
            if (state.isLoggedIn === true && !state.isAdmin && state.messageCount >= MAX_FREE_MESSAGES) {
                alert('Du hast dein Chat-Limit erreicht!');
                return;
            }

            const userMessage = { role: 'user', content: state.input };
            state.messages.push(userMessage);
            state.input = '';
            state.isLoading = true;
            
            if (state.isLoggedIn === false) state.guestMessageCount++;
            else if (state.isLoggedIn === true && !state.isAdmin) state.messageCount++;
            
            render();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: userMessage.content
                    })
                });

                const data = await response.json();
                const aiMessage = {
                    role: 'assistant',
                    content: data.reply || 'ü§ñ Hallo! Ich bin MatEKH!'
                };
                state.messages.push(aiMessage);
                state.isLoading = false;
                
                if (state.currentChatId && state.isLoggedIn === true) {
                    const chatIndex = state.chats.findIndex(c => c.id === state.currentChatId);
                    state.chats[chatIndex].messages = state.messages;
                    state.chats[chatIndex].title = state.messages[0]?.content.slice(0, 30) || 'Neuer Chat';
                    localStorage.setItem('matekh_chats', JSON.stringify(state.chats));
                }
                
                render();
                setTimeout(() => {
                    const chatEl = document.getElementById('chatMessages');
                    if (chatEl) chatEl.scrollTop = chatEl.scrollHeight;
                }, 100);
            } catch (error) {
                console.error('Error:', error);
                const aiMessage = {
                    role: 'assistant',
                    content: 'ü§ñ Demo: Hallo! Backend noch nicht deployed. Deploye erst das Backend auf Vercel!'
                };
                state.messages.push(aiMessage);
                state.isLoading = false;
                render();
            }
        }

        async function generateImage() {
            if (!state.imagePrompt.trim() || state.isLoading) return;
            state.isLoading = true;
            render();
            
            const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(state.imagePrompt)}?width=512&height=512&nologo=true`;
            state.generatedImage = imageUrl;
            state.isLoading = false;
            render();
        }

        function getRemainingTime() {
            const elapsed = Date.now() - state.lastResetTime;
            const remaining = RESET_INTERVAL - elapsed;
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function startGuestTimer() {
            setInterval(() => {
                const now = Date.now();
                if (now - state.lastResetTime >= RESET_INTERVAL) {
                    state.guestMessageCount = 0;
                    state.lastResetTime = now;
                    render();
                }
            }, 60000);
        }

        render();
    </script>
</body>
</html>
